/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All user-generated
 * content is stored in subcollections under that user's private document tree, ensuring
 * that a user can only ever access their own data.
 *
 * Data Structure: User-specific data (video ideas, analyses, media kits) is organized
 * hierarchically under `/usuarios/{usuarioId}`. Global, public-facing data, such as
 * subscription plans, is stored in a separate top-level collection (`/planos_assinatura`)
 * to segregate access patterns cleanly.
 *
 * Key Security Decisions:
 * - User Isolation: Users are strictly confined to their own data tree (`/usuarios/{userId}`).
 *   Listing all users is disabled to protect user privacy.
 * - Public Read-Only Data: The `planos_assinatura` collection is publicly readable by anyone
 *   to allow the application to display plan options, but all write operations are disabled.
 *   This data must be managed through the Firebase Console or a trusted server environment.
 * - Prototyping Flexibility: Data shapes are not strictly enforced. The rules focus solely
 *   on authorization (who can access what) and relational integrity (ensuring a subcollection
 *   document correctly links back to its parent user), allowing the data model to evolve
 *   without constant rule updates.
 *
 * Denormalization for Authorization: To ensure fast and secure authorization, all user-specific
 * documents within subcollections (e.g., IdeiaVideo) must contain a denormalized `usuarioId`
 * field. The rules validate this field on creation and enforce its immutability on update,
 * guaranteeing a permanent and verifiable link to the owner without needing costly `get` calls
 * to parent documents.
 *
 * Structural Segregation: Private user data is kept entirely separate from public application
 * data by using a user-centric collection (`usuarios`) for private information and a top-level
 * collection (`planos_assinatura`) for public information. This is a more secure and performant
 * pattern than mixing public and private documents in the same collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the currently signed-in user's UID matches the provided userId.
     * This is the fundamental check for document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the document already exists and the user is the owner.
     * Used for all state-changing operations (update, delete) to prevent modifying
     * non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that a new user document correctly sets its own ID.
     * This enforces relational integrity between the document ID and its content.
     */
    function isCreatingValidUsuario(usuarioId) {
      return request.resource.data.id == usuarioId;
    }

    /**
     * Enforces that the user document's ID is immutable on update.
     * This prevents re-assigning ownership of the root user document.
     */
    function isUpdatingValidUsuario() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that a new child document (e.g., IdeiaVideo) correctly references
     * its parent user's ID in its 'usuarioId' field.
     */
    function isCreatingValidChildDocument(usuarioId) {
      return request.resource.data.usuarioId == usuarioId;
    }

    /**
     * Enforces that a child document's 'usuarioId' field is immutable on update.
     * This prevents re-assigning ownership of a subcollection document.
     */
    function isUpdatingValidChildDocument() {
      return request.resource.data.usuarioId == resource.data.id;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Rules for a user's own profile document.
     * @path        /usuarios/{usuarioId}
     * @allow       (create) A new user (auth.uid: 'user123') creating their own profile document at /usuarios/user123.
     * @deny        (get) A user (auth.uid: 'user123') trying to read another user's profile at /usuarios/user456.
     * @principle   Restricts access to a user's own data tree and allows self-creation of a profile.
     */
    match /usuarios/{usuarioId} {
      allow get: if isOwner(usuarioId);
      allow list: if isOwner(usuarioId);
      allow create: if isOwner(usuarioId) && isCreatingValidUsuario(usuarioId);
      allow update: if isExistingOwner(usuarioId) && isUpdatingValidUsuario();
      allow delete: if isExistingOwner(usuarioId);
    }

    /**
     * @description Rules for user-owned video ideas.
     * @path        /usuarios/{usuarioId}/ideias_video/{ideiaVideoId}
     * @allow       (create) A user (auth.uid: 'user123') creating a new video idea in their own subcollection.
     * @deny        (update) A user (auth.uid: 'user123') trying to update a video idea in another user's subcollection.
     * @principle   Enforces document ownership for all operations within a user's private subcollection.
     */
    match /usuarios/{usuarioId}/ideias_video/{ideiaVideoId} {
      allow get: if isOwner(usuarioId);
      allow list: if isOwner(usuarioId);
      allow create: if isOwner(usuarioId) && isCreatingValidChildDocument(usuarioId);
      allow update: if isExistingOwner(usuarioId) && isUpdatingValidChildDocument();
      allow delete: if isExistingOwner(usuarioId);
    }

    /**
     * @description Rules for user-owned video analyses.
     * @path        /usuarios/{usuarioId}/analises_video/{analiseVideoId}
     * @allow       (list) A user (auth.uid: 'user123') listing all of their own video analyses.
     * @deny        (delete) A user (auth.uid: 'user123') trying to delete an analysis belonging to 'user456'.
     * @principle   Enforces document ownership for all operations within a user's private subcollection.
     */
    match /usuarios/{usuarioId}/analises_video/{analiseVideoId} {
      allow get: if isOwner(usuarioId);
      allow list: if isOwner(usuarioId);
      allow create: if isOwner(usuarioId) && isCreatingValidChildDocument(usuarioId);
      allow update: if isExistingOwner(usuarioId) && isUpdatingValidChildDocument();
      allow delete: if isExistingOwner(usuarioId);
    }

    /**
     * @description Rules for user-owned media kits.
     * @path        /usuarios/{usuarioId}/kits_midia/{kitMidiaId}
     * @allow       (get) A user (auth.uid: 'user123') reading one of their media kits.
     * @deny        (create) An unauthenticated user trying to create any media kit.
     * @principle   Enforces document ownership for all operations within a user's private subcollection.
     */
    match /usuarios/{usuarioId}/kits_midia/{kitMidiaId} {
      allow get: if isOwner(usuarioId);
      allow list: if isOwner(usuarioId);
      allow create: if isOwner(usuarioId) && isCreatingValidChildDocument(usuarioId);
      allow update: if isExistingOwner(usuarioId) && isUpdatingValidChildDocument();
      allow delete: if isExistingOwner(usuarioId);
    }

    /**
     * @description Rules for subscription plan documents, which are public reference data.
     * @path        /planos_assinatura/{planoAssinaturaId}
     * @allow       (list) Any user, including unauthenticated ones, listing all available subscription plans.
     * @deny        (create) Any client trying to create a new subscription plan. This must be done server-side.
     * @principle   Secures global configuration data as public read-only, preventing any client-side modification.
     */
    match /planos_assinatura/{planoAssinaturaId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}